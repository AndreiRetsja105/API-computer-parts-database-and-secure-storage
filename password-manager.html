<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Password Manager</title>
  <link rel="stylesheet" href="css/style2.css"/>  
  <link rel="stylesheet" href="css/style3.css"/>
  <link rel="stylesheet" href="css/style1.css"/>
</head>
<body>
  <main>
    <div class="pm-wrapper">
      <!-- the page title start here -->
      <h1 class="pm-title">Password Manager</h1>

      <!-- registration and login card is here -->
      <section id="auth" class="pm-card">
        <h2>Register / Login</h2>

        <!-- Register section -->
        <div class="pm-row" style="gap:8px;flex-wrap:wrap">   <!-- row with spacing and wrapping -->
          <input id="reg-username" placeholder="New username" class="pm-input"/>  <!-- user name input  -->
          <input id="reg-email" placeholder="Email (for activation)" type="email" class="pm-input"/>  <!-- email input  -->
          <input id="reg-password" placeholder="Master Password" type="password" class="pm-input"/>  <!-- password input  -->
          <button id="btn-register" class="pm-btn pm-btn-green">Register</button>   <!-- register button -->
        </div>

        <hr style="margin:16px 0;opacity:.3"/>  <!-- devider for two sections Registration/Login Section  -->

        <!-- Login section --> 
        <div class="pm-row" style="gap:8px;flex-wrap:wrap">    <!-- row with spacing and wrapping -->
          <input id="login-username" placeholder="Username" class="pm-input"/>  <!-- user name input -->
          <input id="login-password" placeholder="Master Password" type="password" class="pm-input"/>   <!-- passsword input -->
          <button id="btn-login" class="pm-btn pm-btn-blue">Login</button>   <!-- login button -->
        </div>
        <!-- Success/error message area -->
        <p id="pm-auth-msg" class="pm-msg"></p>
      </section>
    </div>
  </main>


  <!-- //////////script section start here /////////// -->
<script type="module">
import {  /// import helpers from crypto-utils.js which is in the js folder
  b64, ub64,       /// Base64 encode/decode helpers
  pbkdf2Key, pbkdf2Bits,    //help to Print the AES key and hash bits using PBKDF2
  aesGcmEncryptJSON,    // helper with Encrypt Json using AES GCM
  aesGcmDecryptJSON,   // helper with Decrypt Json using AES GCM
  randomBytes           // helper with generate cryptographically secure random bytes
} from './js/crypto-utils.js';   


////////////////// Configuration //////////////////
///////// server where is register and login endpoints exist
const API_BASE = 'https://pm-server.onrender.com';

// Safe join helper //// avoids double slashes or double paths /////
const api = (p) => API_BASE.replace(/\/+$/,'') + '/' + String(p).replace(/^\/+/,'');   /// join base and path safety 


////// HELPERS --------------------------------
function msg(text, ok=false) {     //// display a status message
  const el = document.getElementById('pm-auth-msg');  //// locate mesage element 
  el.textContent = text;               /// set mssage text 
  el.style.color = ok ? 'green' : '';  //// green color for sucess       
}


////////////  Register ///////// with email verification  //////
async function onRegister() {  //// hadle register button 
  try {
    const username = document.getElementById('reg-username').value.trim();  //// get username 
    const email    = document.getElementById('reg-email').value.trim(); /////  get email  
    const password = document.getElementById('reg-password').value;   /////   get password 

    if (!username || !email || !password) {             //// validation 
      msg('Please fill username, email, and password.');  ////  it is inform user 
      return;  /// stop if missinfg fields 
    }

    // 1) generate salt and verifier
    const salt = randomBytes(16);   //// 128 bit random salt 
    const verifierBits = await pbkdf2Bits(password, salt); ////// drive 256-bit ////// verifier with pbkdf2
    const verifierB64  = b64(verifierBits);   ///// base64 encode verifier for transport storage

    // 2) derive AES-GCM key for vault
    const vaultKey = await pbkdf2Key(password, salt);   ////derive webCrypto key used for vault encryption

    // 3) create empty vault and encrypt
    const emptyVault = { version: 1, entries: [] }; // Initial vault structure
    const encVault = await aesGcmEncryptJSON(emptyVault, vaultKey); // encrypt vault to the ///// iv, ciphertext ////////

    // 4) send to server
    const r = await fetch(api('register'), {  ////// post to ///// register ////
      method:'POST',     //// method http 
      headers:{'Content-Type':'application/json'},   //// Json payload 
      body: JSON.stringify({     //// // serialize registration payload
        username,
        email,
        salt: b64(salt),   ///// salt as base64 string
        verifier: verifierB64,   ////// verifier string ///// no raw password /////
        vault: encVault  ////// encrypted vault
      })
    });

    const data = await r.json().catch(()=> ({}));   /////parse Json safely response 
    if (!r.ok) {
      msg(data.error || 'Registration failed.');   //// debugging log 
      return;           //// stop error 
    }
    msg('Registration received. Check your email and click Activate.', true);    //// sucess activation 
  } catch (e) {
    console.error(e);         //// debugging log 
    msg(`Error during registration: ${e?.message || e}`); //// showing the error messasge 
  }
}


////// LOGIN ///// blocked until activated ///////////////
async function onLogin() {  //// handle login buttton 
  try {
    const username = document.getElementById('login-username').value.trim();   //// username input 
    const password = document.getElementById('login-password').value;   ///// password input 
    if (!username || !password) {   ///// validate presence
      msg('Missing credentials.');   ////  message : notify user 
      return;  /// /abort 
    }

    const r = await fetch(api('login'), {    ///// post to //// login ///// 
      method:'POST',   //// method http
      headers:{'Content-Type':'application/json'},   //// Json request
      body: JSON.stringify({ username })      ///// send username to the server, server returns params 
    });

    const data = await r.json().catch(()=> ({}));  /// parse response Json  
    if (r.status === 403) { msg('Account not activated. Check your email.'); return; }   //// Activation gate 
    if (!r.ok) { msg(data.error || 'User not found.'); return; }   ///// another errors 


    ///// data //// username, email, salt, verifier, vault ////
    const salt = ub64(data.salt);  ///// dedcode base64 salt to the Arraybuffer and uint8Array

    ///// PBKDF2 check
    const checkBits = await pbkdf2Bits(password, salt); // re-derive bits from user password
    if (b64(checkBits) !== data.verifier) {   //// compare verifier witch is stored on server
      msg('Bad credentials.');  /// wrong password 
      return;  /// abort to login 
    }

    //// decrypt vault //// prove key is correct //////
    const key = await pbkdf2Key(password, salt);    //// // derive AES key from password and salt
    await aesGcmDecryptJSON(data.vault, key); // try decrypt vault //// throws on failure ////

    ///// success //// go to main app page //////
    window.location.href = 'index.html';  //// after success authentification //// redirect to app ////////
  } catch (e) {  
    console.error(e);   //// unexpected error logs 
    msg('Login error.');  //// message erorr to user  
  }
}

////// wire up buttons
document.getElementById('btn-register').addEventListener('click', onRegister);   //// bind register click 
document.getElementById('btn-login').addEventListener('click', onLogin);  ///  bind login click 

//////// Optional banner if redirected after activation
if (location.hash === '#activated') {     ////// check hash fragment from activation redirect
  msg('Your account is activated. Please log in.', true); //// activation success  
}
</script>
</body>
</html>
